# grep -vE '^#' | tr "\n" ' ' | tr -s ' ' | tr '`' '\n'
# Var2 vent-state Vent fan state
# Var3 co2-state Co2 solenoid state
# Var4 not used

# Rules for controller#1
Rule1 ON Event#LightsOn DO
  backlog Power4 1;
    var4 1;
ENDON ON Event#LightsOff DO
  backlog Power4 0;
    var4 0;
ENDON ON Event#StopGas DO
backlog Power3 0;
    var3 0;
ENDON ON Event#VentOn DO
  backlog Power2 1;
    Event StopGas;
    Var2 1;
ENDON ON Event#VentOff DO
  backlog Power2 0;
    Var2 0;
ENDON ON Event#PumpGas DO 
  backlog Var3 1;
    Power3 1;
    RuleTimer3 10;
#Emit CO2 in response to low ppm detected.
ENDON ON mqtt#Connected DO 
  backlog Subscribe co2ppm, stat/greenhouse/co2sens, co2ppm;
  Subscribe VPD, greenhouse/control2/SENSOR, AM2301.VPD
ENDON ON Event#co2ppm<=1200 DO
  IF (%VAR4% = 1 AND %VAR2% = 0) Event PumpGas
  ENDIF
ENDON ON Rules#Timer=3 DO 
  Event StopGas
ENDON
`Rule2 ON System#Boot DO
  backlog Var1 0;
    Var2 0;
    Var3 0;
    Power1 0;
    Power2 0;
    Power3 0;
    Power4 0;
ENDON ON Clock#Timer=2 DO
  Event GenerateMorning
ENDON ON Clock#Timer=3 DO
  Event GoodNight
ENDON ON Event#GoodMorning DO
  backlog Event LightsOn;
    Event VentOff;
ENDON ON Event#GoodNight DO
  backlog Event LightsOff;
    Event VentOn;
ENDON ON Event#GenerateMorning DO
  Publish cmnd/greenhouses/EVENT GoodMorning
ENDON ON Event#GenerateNight DO
  Publish cmnd/greenhouses/EVENT GoodNight
ENDON

#control2
`Rule1 ON mqtt#Connected DO 
  Subscribe VPD, tele/greenhouse/control2/SENSOR, AM2301.VPD
ENDON ON Event#VPD>9.0 DO
  Power4 0
ENDON ON Event#VPD<9.0 DO
  Power4 1
ENDON ON Event#GoodNight DO
  backlog Power2 0; Power3 1; Power4 0;
    RuleTimer1 600;
ENDON ON Rules#Timer=1 DO
  backlog Power3 0;
ENDON ON Event#GoodMorning DO
  backlog Power2 1; Power3 0; Power4 1;
ENDON


